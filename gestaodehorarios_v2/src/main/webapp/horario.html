<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8" />
<link href="https://unpkg.com/tabulator-tables@4.8.4/dist/css/tabulator.min.css" rel="stylesheet">
<script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.8.4/dist/js/tabulator.min.js"></script>
</head>
<body>
    <h1>Horário</h1>

    <div>
        <input type="file" id="fileInput" accept=".csv">
    </div><br>
    
    <div id="column-selection">
        <label><input type="checkbox" name="column" value="curso" checked>Curso</label>
        <label><input type="checkbox" name="column" value="uc" checked>Unidade Curricular</label>
        <label><input type="checkbox" name="column" value="turno" checked>Turno</label>
        <label><input type="checkbox" name="column" value="turma" checked>Turma</label>
        <label><input type="checkbox" name="column" value="inscritos" checked>Inscritos no Turno</label>
        <label><input type="checkbox" name="column" value="dia" checked>Dia da Semana</label>
        <label><input type="checkbox" name="column" value="horaInicio" checked>Hora início da Aula</label>
        <label><input type="checkbox" name="column" value="horaFim" checked>Hora fim da Aula</label>
        <label><input type="checkbox" name="column" value="data" checked>Data da Aula</label>
        <label><input type="checkbox" name="column" value="caracteristicas" checked>Características da Sala</label>
        <label><input type="checkbox" name="column" value="sala" checked>Sala Atribuída</label>
        <label><input type="checkbox" name="column" value="semanaAno" checked>Semana do ano</label>
        <label><input type="checkbox" name="column" value="semanaSemestre" checked>Semana do semestre</label>
    </div><br>
    
    <div id="example-table"></div>

    <script type="text/javascript">

    var tabledata = []; // Inicializa a variável tabledata
    var table;

    document.getElementById('fileInput').addEventListener('change', handleFileSelect, false);

    // Função para ler o arquivo CSV
    function handleFileSelect(event) {
        var file = event.target.files[0];
        var reader = new FileReader();
        reader.onload = function(e) {
            var contents = e.target.result;
            parseCSV(contents);
        };
        reader.readAsText(file);
    }

    function parseCSV(csv) {
        var lines = csv.trim().split('\n');
        lines.shift(); // Remove o cabeçalho
        
        lines.forEach(function(line) {
            var columns = line.split(';');
            var dataAulaParts = columns[8].split('/');
            var dataAula = new Date(dataAulaParts[2], dataAulaParts[1] - 1, dataAulaParts[0]);
            var semanaAno = getSemanaAno(dataAula);
            var semanaSemestre = getSemanaSemestre(dataAula);
            
            tabledata.push({
                curso: columns[0],
                uc: columns[1],
                turno: columns[2],
                turma: columns[3],
                inscritos: columns[4],
                dia: columns[5],
                horaInicio: columns[6],
                horaFim: columns[7],
                data: columns[8],
                caracteristicas: columns[9],
                sala: columns[10],
                semanaAno: semanaAno,
                semanaSemestre: semanaSemestre
            });
        });
        // Inicializa a tabela Tabulator com os dados lidos
        iniciarTabela();
    }

    // Função para inicializar a tabela Tabulator
    function iniciarTabela() {
        table = new Tabulator("#example-table", {
            data: tabledata,
            layout: "fitDatafill",
            pagination: "local",
            paginationSize: 10,
            paginationSizeSelector: [5, 10, 20, 40],
            movableColumns: true,
            paginationCounter: "rows",
            initialSort: [{ column: "curso", dir: "asc" }], // Corrigido o nome da coluna para o valor correto
            columns: [
                { title: "Curso", field: "curso", headerFilter: "input" },
                { title: "Unidade Curricular", field: "uc", headerFilter: "input" },
                { title: "Turno", field: "turno", headerFilter: "input" },
                { title: "Turma", field: "turma", headerFilter: "input" },
                { title: "Inscritos no turno", field: "inscritos", headerFilter: "input" },
                { title: "Dia da Semana", field: "dia", headerFilter: "input" },
                { title: "Hora início da aula", field: "horaInicio", headerFilter: "input" },
                { title: "Hora fim da aula", field: "horaFim", headerFilter: "input" },
                { title: "Data da aula", field: "data", headerFilter: "input" },
                { title: "Características da sala pedida para a aula", field: "caracteristicas", headerFilter: "input" },
                { title: "Sala atribuída", field: "sala", headerFilter: "input" },
                { title: "Semana do ano", field: "semanaAno", headerFilter: "input" },
                { title: "Semana do semestre", field: "semanaSemestre", headerFilter: "input" },
            ],
        });
        
        // Adiciona um listener para as caixas de seleção
        var checkboxes = document.querySelectorAll('input[type=checkbox][name=column]');
        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                var column = this.value;
                var visible = this.checked;
                table.toggleColumn(column, visible);
            });
        });
    }
    
	 // Função para calcular o número da semana do ano
    function getSemanaAno(date) {
        var d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return weekNo;
    }
	 
 	// Função para calcular a semana do semestre
    function getSemanaSemestre(date) {
        var month = date.getMonth(); // Janeiro - 0, ...
        var firstDaySemester;
        
        if (month >= 8) { // De setembro a dezembro pertence ao 1º semestre
            firstDaySemester = new Date(date.getFullYear(), 8, 1); // 1 de Setembro - Data do início do 1º semestre
        } else if (month < 1) { // Janeiro pertence ao 1º semestre do ano anterior
            firstDaySemester = new Date(date.getFullYear() - 1, 8, 1); // 1 de Setembro - Data do início do 1º semestre do ano anterior
        } else { // De fevereiro a agosto pertence ao 2º semestre
            firstDaySemester = new Date(date.getFullYear(), 1, 1); // 1 de Fevereiro - Data do início do 2º semestre
        }
        
        var diff = date.getTime() - firstDaySemester.getTime();
        var oneWeek = 7 * 24 * 60 * 60 * 1000;
        var semanaSemestre = Math.floor(diff / oneWeek) + 1;
        return semanaSemestre;
    }




    </script>
</body>
</html>
